<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nyan Collision Test</title>
    <style>
      * { box-sizing: border-box; }
      html, body { width: 100%; height: 100%; margin: 0; }
      body { overflow: hidden; background: #22497b; }
      .stage { position: relative; width: 100%; height: 100vh; }

      .sparkle-field {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
      }

      .sparkle-frame6 { animation: sparkle 0.42s linear 0.35s infinite; }
      .sparkle-frame5 { animation: sparkle 0.42s linear 0.28s infinite; }
      .sparkle-frame4 { animation: sparkle 0.42s linear 0.21s infinite; }
      .sparkle-frame3 { animation: sparkle 0.42s linear 0.14s infinite; }
      .sparkle-frame2 { animation: sparkle 0.42s linear 0.07s infinite; }
      .sparkle-frame1 { animation: sparkle 0.42s linear 0s infinite; }
      @keyframes sparkle {
        0%, 16.666666% { opacity: 1; }
        16.6666666%, 100% { opacity: 0; }
      }

      #cat-layer {
        position: absolute;
        inset: 0;
      }

      .cat-entity {
        position: absolute;
        width: 220px;
        height: 58px;
        will-change: transform;
      }

      .layer {
        position: absolute;
        top: 0;
        left: 0;
        display: block;
        width: 100%;
        height: auto;
      }

      .trail-1 { transform: translateX(-126px); opacity: 0.22; }
      .trail-2 { transform: translateX(-84px); opacity: 0.4; }
      .trail-3 { transform: translateX(-46px); opacity: 0.62; }
      .sprite { z-index: 5; }
    </style>
  </head>
  <body>
    <main class="stage" aria-label="Collision test: multiple Nyan Cats bouncing with walls and each other">
      <svg class="sparkle-field" viewBox="0 0 320 180" preserveAspectRatio="none" aria-hidden="true">
        <defs>
          <g id="sparkle" transform="scale(0.9)" stroke="#d9f0ff">
            <path class="sparkle-frame1" d="M3.5 0 v2 M7 3.5 h-2 M3.5 7 v-2 M0 3.5 h2 M3 3.5 h1" />
            <path class="sparkle-frame2" d="M3 0.5 h1 M5 1.5 h1 M6 3.5 h1 M5 5.5 h1 M3 6.5 h1 M1 5.5 h1 M0 3.5 h1 M1 1.5 h1" />
            <path class="sparkle-frame3" d="M3 0.5 h1 M6 3.5 h1 M3 6.5 h1 M0 3.5 h1" />
            <path class="sparkle-frame4" d="M3 3.5 h1" />
            <path class="sparkle-frame5" d="M3 2.5 h1 M4 3.5 h1 M3 4.5 h1 M2 3.5 h1" />
            <path class="sparkle-frame6" d="M3.5 1 v2 M4 3.5 h2 M3.5 4 v2 M1 3.5 h2" />
          </g>
        </defs>
        <use href="#sparkle"><animateMotion dur="0.77s" repeatCount="indefinite" path="M250 10 70 10" /></use>
        <use href="#sparkle"><animateMotion begin="0.2566s" dur="0.77s" repeatCount="indefinite" path="M255 23 65 23" /></use>
        <use href="#sparkle"><animateMotion begin="0.5133s" dur="0.77s" repeatCount="indefinite" path="M260 36 60 36" /></use>
        <use href="#sparkle"><animateMotion begin="0.1283s" dur="0.77s" repeatCount="indefinite" path="M260 130 60 130" /></use>
        <use href="#sparkle"><animateMotion begin="0.385s" dur="0.77s" repeatCount="indefinite" path="M255 143 65 143" /></use>
        <use href="#sparkle"><animateMotion begin="0.6416s" dur="0.77s" repeatCount="indefinite" path="M250 166 70 166" /></use>
      </svg>

      <div id="cat-layer"></div>
          <div style="position:absolute;left:12px;bottom:10px;color:#cfe8ff;font:14px monospace;opacity:.85;">Cats: 6 (wall + cat collisions)</div>
    </main>

    <template id="cat-template">
      <div class="cat-entity">
        <img class="layer trail-1" src="nyan-trail.svg" alt="" aria-hidden="true" />
        <img class="layer trail-2" src="nyan-trail.svg" alt="" aria-hidden="true" />
        <img class="layer trail-3" src="nyan-trail.svg" alt="" aria-hidden="true" />
        <img class="layer sprite" src="nyan-sprite.svg" alt="Animated Nyan Cat collision test" />
      </div>
    </template>

    <script>
      const CAT = { w: 220, h: 58, r: 34 };
      const catLayer = document.getElementById('cat-layer');
      const catTemplate = document.getElementById('cat-template');

      const cats = [
        { x: 80, y: 70, vx: 3.1, vy: 2.0 },
        { x: 420, y: 140, vx: -2.9, vy: 2.4 },
        { x: 740, y: 250, vx: 2.7, vy: -2.2 },
        { x: 1040, y: 360, vx: -3.2, vy: -2.1 },
        { x: 260, y: 480, vx: 2.5, vy: -2.8 },
        { x: 900, y: 90, vx: -2.6, vy: 2.3 }
      ].map((c) => {
        const node = catTemplate.content.firstElementChild.cloneNode(true);
        catLayer.appendChild(node);
        return { ...c, node };
      });

      function bounceWalls(cat) {
        const maxX = window.innerWidth - CAT.w;
        const maxY = window.innerHeight - CAT.h;

        if (cat.x <= 0) {
          cat.x = 0;
          cat.vx = Math.abs(cat.vx);
        } else if (cat.x >= maxX) {
          cat.x = maxX;
          cat.vx = -Math.abs(cat.vx);
        }

        if (cat.y <= 0) {
          cat.y = 0;
          cat.vy = Math.abs(cat.vy);
        } else if (cat.y >= maxY) {
          cat.y = maxY;
          cat.vy = -Math.abs(cat.vy);
        }
      }

      function resolveCatCollision(a, b) {
        const ax = a.x + CAT.w * 0.56;
        const ay = a.y + CAT.h * 0.5;
        const bx = b.x + CAT.w * 0.56;
        const by = b.y + CAT.h * 0.5;

        const dx = bx - ax;
        const dy = by - ay;
        const distSq = dx * dx + dy * dy;
        const minDist = CAT.r * 2;

        if (distSq === 0 || distSq >= minDist * minDist) return;

        const dist = Math.sqrt(distSq);
        const nx = dx / dist;
        const ny = dy / dist;

        const overlap = minDist - dist;
        a.x -= nx * overlap * 0.5;
        a.y -= ny * overlap * 0.5;
        b.x += nx * overlap * 0.5;
        b.y += ny * overlap * 0.5;

        const rvx = a.vx - b.vx;
        const rvy = a.vy - b.vy;
        const velAlongNormal = rvx * nx + rvy * ny;

        if (velAlongNormal > 0) return;

        const impulse = -2 * velAlongNormal / 2;
        a.vx += impulse * nx;
        a.vy += impulse * ny;
        b.vx -= impulse * nx;
        b.vy -= impulse * ny;
      }

      function render(cat) {
        const facing = cat.vx >= 0 ? 1 : -1;
        cat.node.style.transform = `translate(${cat.x}px, ${cat.y}px) scaleX(${facing})`;
      }

      function tick() {
        for (const cat of cats) {
          cat.x += cat.vx;
          cat.y += cat.vy;
          bounceWalls(cat);
        }

        for (let i = 0; i < cats.length; i += 1) {
          for (let j = i + 1; j < cats.length; j += 1) {
            resolveCatCollision(cats[i], cats[j]);
          }
        }

        for (const cat of cats) {
          bounceWalls(cat);
          render(cat);
        }

        requestAnimationFrame(tick);
      }

      requestAnimationFrame(tick);
    </script>
  </body>
</html>
